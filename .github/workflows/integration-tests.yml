name: Run integration tests

on:
  push: #TODO for test purpose. change to main only
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "integration-tests"
  cancel-in-progress: false

jobs:
  integration-tests:
    environment:
      name: pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

#      - name: Set up Kind
#        uses: helm/kind-action@v1.12.0
#        with:
#          cluster_name: kind

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

#      - name: Checkout cloud core bootstrap repo
#        uses: actions/checkout@v4
#        with:
#          repository: Netcracker/qubership-core-bootstrap
#          path: core-bootstrap-repo
#
#      - name: Deploy cloud core
#        run: make -C core-bootstrap-repo/cloud-core-local-dev/ install

      - name: Run integration tests
        run: mvn clean surefire-report:report
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Update report history
        run: |
          mkdir -p report
          history_file="report/history.json"
          [ -f "$history_file" ] || echo "{}" > "$history_file"
          
          today=$(date -u +"%Y-%m-%d")
          day_dir="report/$today"
          mkdir -p "$day_dir"
          
          # Copy Surefire HTML report to daily folder
          cp -r target/reports/* "$day_dir/"
          mv "$day_dir/surefire.html" "$day_dir/index.html"
          
          # Parse XML reports
          successes=0
          failures=0
          
          for f in target/surefire-reports/TEST-*.xml; do
            [ -f "$f" ] || continue
            
            # Grab all numeric values of attributes tests / failures / errors in this file.
            # We query both testsuite and testsuites attributes to be safe.
            tests_attrs=$(xmllint --xpath '//testsuite/@tests | //testsuites/@tests' "$f" 2>/dev/null || echo "")
            fails_attrs=$(xmllint --xpath '//testsuite/@failures | //testsuites/@failures' "$f" 2>/dev/null || echo "")
            errs_attrs=$(xmllint --xpath '//testsuite/@errors | //testsuites/@errors' "$f" 2>/dev/null || echo "")
            
            # Sum numbers found in each attribute string (e.g. tests="1" tests="2" ...)
            t_sum=0
            for n in $(echo "$tests_attrs" | grep -oE '[0-9]+' || true); do
              t_sum=$((t_sum + n))
            done
            
            f_sum=0
            for n in $(echo "$fails_attrs" | grep -oE '[0-9]+' || true); do
              f_sum=$((f_sum + n))
            done
            
            e_sum=0
            for n in $(echo "$errs_attrs" | grep -oE '[0-9]+' || true); do
              e_sum=$((e_sum + n))
            done
            
            # Defensive: ensure non-negative
            if [ "$t_sum" -lt 0 ]; then t_sum=0; fi
            if [ "$f_sum" -lt 0 ]; then f_sum=0; fi
            if [ "$e_sum" -lt 0 ]; then e_sum=0; fi
            
            successes=$((successes + t_sum - f_sum - e_sum))
            failures=$((failures + f_sum + e_sum))
            
            echo "DEBUG: $f -> tests=$t_sum failures=$f_sum errors=$e_sum"
          done
          
          # Final safeguard: no negative successes
          if [ "$successes" -lt 0 ]; then successes=0; fi
          fail
          
          echo "Successes=$successes, Failures=$failures"
          
          status="success"
          [ "$failures" -gt 0 ] && status="failure"
          
          tmpfile=$(mktemp)
          cp "$history_file" "$tmpfile"
          jq --arg day "$today" --arg status "$status" \
             --argjson successes "$successes" --argjson failures "$failures" \
             --arg path "$today" '.[$day]={status:$status,successes:$successes,failures:$failures,path:$path}' \
             "$tmpfile" > "$tmpfile.new"
          mv "$tmpfile.new" "$history_file"

      - name: Copy HTML template
        run: cp report-template.html report/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
