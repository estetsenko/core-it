name: Run integration tests

on:
  push: #TODO for test purpose. change to main only
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "integration-tests"
  cancel-in-progress: false

jobs:
  integration-tests:
    environment:
      name: pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

#      - name: Set up Kind
#        uses: helm/kind-action@v1.12.0
#        with:
#          cluster_name: kind

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

#      - name: Checkout cloud core bootstrap repo
#        uses: actions/checkout@v4
#        with:
#          repository: Netcracker/qubership-core-bootstrap
#          path: core-bootstrap-repo
#
#      - name: Deploy cloud core
#        run: make -C core-bootstrap-repo/cloud-core-local-dev/ install

      - name: Run integration tests
        run: mvn clean surefire-report:report
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Update report history
        run: |
          today=$(date +%Y-%m-%d)
          mkdir -p report/pages/$today
          cp -r target/reports/* report/pages/$today/ || true
          mv report/pages/$today/surefire.html report/pages/$today/index.html 
          cp report-template.html report/index.html
          
          successes=0
          failures=0

          for f in target/surefire-reports/TEST-*.xml; do
            tests=$(xmllint --xpath "string(//testsuite/@tests)" "$f" 2>/dev/null)
            fails=$(xmllint --xpath "string(//testsuite/@failures)" "$f" 2>/dev/null || echo 0)
            errs=$(xmllint --xpath "string(//testsuite/@errors)" "$f" 2>/dev/null || echo 0)

            successes=$((successes + tests - fails - errs))
            failures=$((failures + fails + errs))
          done

          echo "Successes=$successes"
          echo "Failures=$failures"
          echo "SUCCESS_COUNT=$successes" >> $GITHUB_ENV
          echo "FAILURE_COUNT=$failures" >> $GITHUB_ENV

          # prepare or update history.json
          if [ ! -f report/history.json ]; then
            echo '{}' > report/history.json
          fi

          jq --arg date "$today" \
             --argjson succ "$successes" \
             --argjson fail "$failures" \
             '.[$date] = {successes: $succ, failures: $fail, path: $date}' \
             report/history.json > report/tmp.json && mv report/tmp.json report/history.json

          # cleanup older than 7 days
          for d in $(ls report/pages | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'); do
            if [ "$(date -d "$d" +%s)" -lt "$(date -d '7 days ago' +%s)" ]; then
              rm -rf "report/pages/$d"
              jq "del(.\"$d\")" report/history.json > report/tmp.json && mv report/tmp.json report/history.json
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
