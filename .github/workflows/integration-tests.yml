name: Run integration tests

on:
  push: #TODO for test purpose. change to main only
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "integration-tests"
  cancel-in-progress: false

jobs:
  integration-tests:
    environment:
      name: pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

#      - name: Set up Kind
#        uses: helm/kind-action@v1.12.0
#        with:
#          cluster_name: kind

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

#      - name: Checkout cloud core bootstrap repo
#        uses: actions/checkout@v4
#        with:
#          repository: Netcracker/qubership-core-bootstrap
#          path: core-bootstrap-repo
#
#      - name: Deploy cloud core
#        run: make -C core-bootstrap-repo/cloud-core-local-dev/ install

      - name: Run integration tests
        run: mvn clean surefire-report:report
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Update report history
        run: |
          mkdir -p report
          history_file="report/history.json"
          [ -f "$history_file" ] || echo "{}" > "$history_file"
          
          today=$(date -u +"%Y-%m-%d")
          day_dir="report/$today"
          mkdir -p "$day_dir"
          
          # Copy Surefire HTML report to daily folder
          cp -r target/reports/* "$day_dir/"
          mv "$day_dir/surefire.html" "$day_dir/index.html"
          
          # Parse XML reports
          successes=0
          failures=0
          
          for f in target/surefire-reports/TEST-*.xml; do
          [ -f "$f" ] || continue
        
          # Get all <testsuite> attributes and sum in bash
          while IFS= read -r line; do
            run=$(echo "$line" | sed -n 's/.*tests="\([0-9]*\)".*/\1/p')
            fail=$(echo "$line" | sed -n 's/.*failures="\([0-9]*\)".*/\1/p')
            error=$(echo "$line" | sed -n 's/.*errors="\([0-9]*\)".*/\1/p')
            successes=$((successes + run - fail - error))
            failures=$((failures + fail + error))
          done < <(xmllint --xpath '//testsuite' "$f" 2>/dev/null)
          done
          
          echo "Successes=$successes, Failures=$failures"
          
          echo "Successes=$successes, Failures=$failures"

          
          status="success"
          [ "$failures" -gt 0 ] && status="failure"
          
          tmpfile=$(mktemp)
          cp "$history_file" "$tmpfile"
          jq --arg day "$today" --arg status "$status" \
             --argjson successes "$successes" --argjson failures "$failures" \
             --arg path "$today" '.[$day]={status:$status,successes:$successes,failures:$failures,path:$path}' \
             "$tmpfile" > "$tmpfile.new"
          mv "$tmpfile.new" "$history_file"

      - name: Copy HTML template
        run: cp report-template.html report/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
