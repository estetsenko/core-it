name: Run integration tests

on:
  push: #TODO for test purpose. change to main only
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "integration-tests"
  cancel-in-progress: false

jobs:
  integration-tests:
    environment:
      name: pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

#      - name: Set up Kind
#        uses: helm/kind-action@v1.12.0
#        with:
#          cluster_name: kind

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

#      - name: Checkout cloud core bootstrap repo
#        uses: actions/checkout@v4
#        with:
#          repository: Netcracker/qubership-core-bootstrap
#          path: core-bootstrap-repo
#
#      - name: Deploy cloud core
#        run: make -C core-bootstrap-repo/cloud-core-local-dev/ install

      - name: Run integration tests
        run: mvn clean surefire-report:report
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Restore history cache
        uses: actions/cache@v4
        with:
          path: report/history.json
          key: report-history

      - name: Update report history
        run: |
          gh cache delete "report-history"
          today=$(date +%Y-%m-%d)
          mkdir -p report/reports/$today/pages
          cp -r target/surefire-reports/* report/reports/$today || true
          cp -r target/reports/* report/reports/$today/pages || true
          mv report/reports/$today/pages/surefire.html report/reports/$today/pages/index.html 
          cp report-template.html report/index.html
          
          successes=0
          failures=0

          for f in target/surefire-reports/TEST-*.xml; do
            line=$(grep -o '<testsuite[^>]*>' "$f" | head -n1)
            tests=$(echo "$line" | sed -n 's/.*tests="\([0-9]\+\)".*/\1/p')
            fails=$(echo "$line" | sed -n 's/.*failures="\([0-9]\+\)".*/\1/p')
            errs=$(echo "$line" | sed -n 's/.*errors="\([0-9]\+\)".*/\1/p')
          
            tests=${tests:-0}
            fails=${fails:-0}
            errs=${errs:-0}
          
            successes=$((successes + tests - fails - errs))
            failures=$((failures + fails + errs))
          done

          echo "Successes=$successes"
          echo "Failures=$failures"
          echo "SUCCESS_COUNT=$successes" >> $GITHUB_ENV
          echo "FAILURE_COUNT=$failures" >> $GITHUB_ENV

          # prepare or update history.json
          if [ ! -f report/history.json ]; then
            echo '{}' > report/history.json
          fi

          jq --arg date "$today" \
          --arg succ "$successes" \
          --arg fail "$failures" \
          --arg p "reports/$today/pages/" \
          '.[$date] = {successes: ($succ|tonumber), failures: ($fail|tonumber), path: $p}' \
          report/history.json > report/tmp.json && mv report/tmp.json report/history.json

          # cleanup older than 7 days
          for d in $(ls report/reports | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'); do
            if [ "$(date -d "$d" +%s)" -lt "$(date -d '7 days ago' +%s)" ]; then
              rm -rf "report/reports/$d"
              jq "del(.\"$d\")" report/history.json > report/tmp.json && mv report/tmp.json report/history.json
            fi
          done

      - name: Save history cache
        uses: actions/cache/save@v4
        with:
          path: report/history.json
          key: report-history

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
