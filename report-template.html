<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" sizes="any" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>"/>
    <title>Daily Integration Tests Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f7f9fc; }
        h1 { text-align: center; }
        table { width: 95%; margin: 20px auto; border-collapse: collapse; }
        th, td { padding: 6px 10px; text-align: center; border: 1px solid #ddd; }
        th { background: #4f46e5; color: white; }
        .success { background: #16a34a; color: white; }
        .failure { background: #dc2626; color: white; }
        canvas { display: block; margin: 40px auto; }
    </style>
</head>
<body>
<h1>Daily Integration Tests Report</h1>

<canvas id="weeklyChart" width="900" height="400"></canvas>

<table id="reportTable">
    <tr><th>Date</th></tr>
</table>

<script>
    fetch('history.json')
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById('reportTable');
        const labels = [];
        const passedData = [];
        const failedData = [];

        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setUTCDate(d.getUTCDate() - i);
          days.push(d.toISOString().slice(0, 10));
        }
        const today = new Date().toISOString().slice(0, 10);

        // Collect all projects
        const projects = new Set();
        Object.values(data).forEach(entry => {
          if (entry.projects) {
            Object.keys(entry.projects).forEach(p => projects.add(p));
          }
        });
        const sortedProjects = Array.from(projects).sort();

        // Add project headers
        const headerRow = table.rows[0];
        sortedProjects.forEach(project => {
          const th = document.createElement('th');
          th.textContent = project;
          headerRow.appendChild(th);
        });

        // Fill rows
        days.forEach(day => {
          labels.push(day);
          const entry = data[day] || {};
          const row = document.createElement('tr');

          const dateCell = document.createElement('td');
          dateCell.textContent = day;
          row.appendChild(dateCell);

          let totalPass = 0, totalFail = 0;

          sortedProjects.forEach(project => {
            const projectData = entry.projects ? entry.projects[project] : null;
            const cell = document.createElement('td');

            if (projectData) {
              totalPass += projectData.successes;
              totalFail += projectData.failures;

              if (projectData.failures > 0) {
                cell.className = 'failure';
              } else {
                cell.className = 'success';
              }

              if (day === today) {
                const link = document.createElement('a');
                link.href = projectData.path + '/index.html';
                link.target = '_blank';
                link.textContent = `${projectData.successes}/${projectData.failures}`;
                cell.appendChild(link);
              } else {
                cell.textContent = `${projectData.successes}/${projectData.failures}`;
              }
            } else {
              cell.textContent = '-';
            }
            row.appendChild(cell);
          });

          passedData.push(totalPass);
          failedData.push(totalFail);

          table.appendChild(row);
        });

        // Chart (legend removed)
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              { label: 'Passed', data: passedData, backgroundColor: '#16a34a' },
              { label: 'Failed', data: failedData, backgroundColor: '#dc2626' }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Total Tests Passed vs Failed (Last 7 Days)' }
            },
            scales: { y: { beginAtZero: true, precision:0 } }
          }
        });
      })
      .catch(err => console.error('Failed to load history.json', err));
</script>
</body>
</html>
