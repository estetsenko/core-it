<script>
    fetch('history.json')
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById('reportTable');
        const labels = [];
        const passedData = {};
        const failedData = {};
        const barLinks = {}; // store links for each dataset

        const projects = new Set();
        Object.values(data).forEach(dayEntry => {
          Object.keys(dayEntry).forEach(p => projects.add(p));
        });
        const projectList = [...projects].sort();

        const header = document.createElement('tr');
        header.innerHTML = '<th>Date</th>' + projectList.map(p => `<th>${p}</th>`).join('');
        table.appendChild(header);

        const days = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setUTCDate(d.getUTCDate() - i);
          days.push(d.toISOString().slice(0, 10));
        }

        const today = new Date().toISOString().slice(0, 10);

        projectList.forEach(p => {
          passedData[p] = [];
          failedData[p] = [];
          barLinks[p] = { passed: [], failed: [] };
        });

        days.reverse();

        days.forEach(day => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${day}</td>`;
          labels.push(day);

          projectList.forEach(project => {
            const cell = document.createElement('td');
            const entry = data[day] && data[day][project];

            if (entry) {
              const txt = entry.failures > 0 ? 'Failure' : 'Success';
              const cls = entry.failures > 0 ? 'failure' : 'success';

              if (day === today) {
                const link = document.createElement('a');
                link.href = entry.path + 'index.html';
                link.target = '_blank';
                link.textContent = txt;
                link.className = cls;
                cell.appendChild(link);
              } else {
                const span = document.createElement('span');
                span.textContent = txt;
                span.className = cls;
                cell.appendChild(span);
              }

              passedData[project].push(entry.successes);
              failedData[project].push(entry.failures);

              // store links for the chart
              barLinks[project].passed.push(entry.path + 'index.html');
              barLinks[project].failed.push(entry.path + 'index.html');

            } else {
              cell.textContent = '-';
              passedData[project].push(0);
              failedData[project].push(0);
              barLinks[project].passed.push(null);
              barLinks[project].failed.push(null);
            }

            row.appendChild(cell);
          });

          table.appendChild(row);
        });

        // Build datasets for chart
        const datasets = [];
        projectList.forEach(project => {
          datasets.push({
            label: project + ' Passed',
            data: passedData[project],
            backgroundColor: '#16a34a',
            stack: project,
            custom: { links: barLinks[project].passed } // attach links
          });
          datasets.push({
            label: project + ' Failed',
            data: failedData[project],
            backgroundColor: '#dc2626',
            stack: project,
            custom: { links: barLinks[project].failed }
          });
        });

        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyChart = new Chart(ctx, {
          type: 'bar',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Tests Passed vs Failed (Last 7 Days, per project)', font: { size: 18, weight: '600' } }
            },
            scales: { y: { beginAtZero: true, precision: 0 } },
            onClick: (evt, elements) => {
              if (!elements.length) return;
              const element = elements[0];
              const datasetIndex = element.datasetIndex;
              const dataIndex = element.index;
              const link = weeklyChart.data.datasets[datasetIndex].custom.links[dataIndex];
              if (link) window.open(link, '_blank');
            }
          }
        });

      })
      .catch(err => console.error('Failed to load history.json', err));
</script>
